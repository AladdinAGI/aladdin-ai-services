<!doctype html>
<html lang="zh">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>加密货币 AI 助手</title>
		<!-- 添加必要的依赖 -->

		<script src="https://code.highcharts.com/highcharts.js"></script>
		<script src="https://code.highcharts.com/modules/accessibility.js"></script>
		<style>
			/* 基础样式 */
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: Arial, sans-serif;
				height: 100vh;
				display: flex;
			}

			/* 左侧历史记录 */
			.history-panel {
				width: 250px;
				background: #f7f7f7;
				padding: 20px;
				border-right: 1px solid #ddd;
				overflow-y: auto;
			}

			.history-item {
				padding: 10px;
				margin-bottom: 8px;
				background: white;
				border-radius: 8px;
				cursor: pointer;
				border: 1px solid #eee;
			}

			.history-item:hover {
				background: #f0f0f0;
			}

			/* 中间聊天区域 */
			.chat-panel {
				flex: 1;
				display: flex;
				flex-direction: column;
				background: white;
			}

			.chat-history {
				flex: 1;
				padding: 20px;
				overflow-y: auto;
			}

			.message {
				margin-bottom: 20px;
				max-width: 80%;
				white-space: pre-wrap;
				word-wrap: break-word;
			}

			.user-message {
				margin-left: auto;
				background: #007bff;
				color: white;
				padding: 12px 16px;
				border-radius: 12px 12px 0 12px;
			}

			.bot-message {
				background: #f8f9fa;
				padding: 12px 16px;
				border-radius: 12px 12px 12px 0;
				border: 1px solid #eee;
			}

			/* 加密货币相关样式 */
			.crypto-chart-container {
				background: white;
				border-radius: 8px;
				padding: 16px;
				margin-top: 16px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}

			.crypto-price {
				background: white;
				border-radius: 8px;
				padding: 16px;
			}

			.price-main {
				font-size: 24px;
				font-weight: bold;
				margin: 8px 0;
			}

			.price-change {
				font-size: 16px;
				margin: 8px 0;
			}

			.price-change.positive {
				color: #28a745;
			}

			.price-change.negative {
				color: #dc3545;
			}

			.price-info {
				color: #6c757d;
				margin: 4px 0;
			}

			/* 快捷问题区域 */
			.quick-questions {
				padding: 15px;
				border-bottom: 1px solid #ddd;
				display: flex;
				gap: 10px;
				overflow-x: auto;
			}

			.quick-question {
				padding: 8px 16px;
				background: white;
				border: 1px solid #ddd;
				border-radius: 20px;
				cursor: pointer;
				white-space: nowrap;
			}

			.quick-question:hover {
				background: #f0f0f0;
			}

			/* 输入区域 */
			.input-area {
				padding: 20px;
				border-top: 1px solid #ddd;
				background: #f8f9fa;
			}

			#messageInput {
				width: 100%;
				padding: 12px;
				border: 1px solid #ddd;
				border-radius: 8px;
				margin-bottom: 10px;
				resize: vertical;
				min-height: 60px;
			}

			#sendButton {
				padding: 10px 20px;
				background: #007bff;
				color: white;
				border: none;
				border-radius: 8px;
				cursor: pointer;
			}

			#sendButton:hover {
				background: #0056b3;
			}

			/* 右侧钱包区域 */
			.wallet-panel {
				width: 300px;
				background: #f7f7f7;
				padding: 20px;
				border-left: 1px solid #ddd;
			}

			.wallet-connect {
				padding: 10px;
				background: #28a745;
				color: white;
				border: none;
				border-radius: 4px;
				width: 100%;
				cursor: pointer;
				margin-bottom: 15px;
			}

			.wallet-connect:hover {
				background: #218838;
			}

			.loading {
				display: none;
				text-align: center;
				padding: 20px;
			}

			.loading.active {
				display: block;
			}
			.security-analysis {
				background: white;
				border-radius: 8px;
				padding: 20px;
				margin-top: 16px;
			}

			.security-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 16px;
			}

			.risk-badge {
				padding: 6px 12px;
				border-radius: 4px;
				font-weight: bold;
			}

			.risk-HIGH {
				background: #dc3545;
				color: white;
			}

			.risk-MEDIUM {
				background: #ffc107;
				color: black;
			}

			.risk-LOW {
				background: #28a745;
				color: white;
			}

			.security-details {
				border: 1px solid #eee;
				border-radius: 8px;
				margin-top: 16px;
			}

			.detail-item {
				padding: 12px;
				border-bottom: 1px solid #eee;
				display: flex;
				justify-content: space-between;
			}

			.detail-item:last-child {
				border-bottom: none;
			}
		</style>
	</head>
	<body>
		<div class="history-panel">
			<h3>历史记录</h3>
			<div id="historyList"></div>
		</div>

		<div class="chat-panel">
			<div class="quick-questions">
				<button class="quick-question" data-question="比特币的当前价格是多少？">比特币价格</button>
				<button class="quick-question" data-question="推荐一些稳定币质押方案">推荐质押方案</button>
				<button class="quick-question" data-question="检查合约地址安全性">检查合约安全</button>
				<button class="quick-question" data-question="你是谁？">关于AI助手</button>
			</div>

			<div class="chat-history" id="chatHistory"></div>

			<div id="loading" class="loading">AI思考中...</div>

			<div class="input-area">
				<textarea id="messageInput" placeholder="请输入你的问题..." rows="3"></textarea>
				<button id="sendButton">发送</button>
			</div>
		</div>

		<div class="wallet-panel">
			<button id="connectWallet" class="wallet-connect">连接钱包</button>
			<div id="walletInfo"></div>
		</div>
		<!-- 在 body 标签结束前添加以下脚本 -->
		<script>
			// 价格图表组件
			const CryptoPriceChart = ({ data, symbol }) => {
				const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

				const formatPrice = (value) => {
					return new Intl.NumberFormat('en-US', {
						style: 'currency',
						currency: 'USD',
						minimumFractionDigits: 2,
						maximumFractionDigits: 2,
					}).format(value);
				};

				const formatDate = (dateStr) => {
					const date = new Date(dateStr);
					return `${date.getMonth() + 1}/${date.getDate()}`;
				};

				return React.createElement('div', { className: 'crypto-chart-container' }, [
					React.createElement('h3', { className: 'text-lg font-semibold mb-4' }, `${symbol} 价格走势`),
					React.createElement(
						ResponsiveContainer,
						{ width: '100%', height: 400 },
						React.createElement(
							LineChart,
							{ data: data, margin: { top: 5, right: 30, left: 20, bottom: 5 } },
							[
								React.createElement(CartesianGrid, { strokeDasharray: '3 3' }),
								React.createElement(XAxis, { dataKey: 'date', tickFormatter: formatDate }),
								React.createElement(YAxis, { tickFormatter: formatPrice }),
								React.createElement(Tooltip, {
									formatter: (value) => formatPrice(value),
									labelFormatter: (date) => new Date(date).toLocaleDateString(),
								}),
								React.createElement(Legend),
								React.createElement(Line, {
									type: 'monotone',
									dataKey: 'close',
									stroke: '#8884d8',
									dot: false,
									name: '价格',
								}),
							],
						),
					),
				]);
			};

			class ChatApp {
				constructor() {
					this.messageInput = document.getElementById('messageInput');
					this.sendButton = document.getElementById('sendButton');
					this.chatHistory = document.getElementById('chatHistory');
					this.loading = document.getElementById('loading');
					this.historyList = document.getElementById('historyList');
					this.connectWallet = document.getElementById('connectWallet');
					this.walletInfo = document.getElementById('walletInfo');

					this.cryptoMap = {
						比特币: 'BTC',
						以太坊: 'ETH',
						泰达币: 'USDT',
						币安币: 'BNB',
						索拉纳: 'SOL',
					};

					this.initializeEventListeners();
					this.checkWalletConnection();
				}

				initializeEventListeners() {
					this.sendButton.addEventListener('click', () => this.sendMessage());
					this.messageInput.addEventListener('keypress', (e) => {
						if (e.key === 'Enter' && !e.shiftKey) {
							e.preventDefault();
							this.sendMessage();
						}
					});

					document.querySelectorAll('.quick-question').forEach((button) => {
						button.addEventListener('click', () => {
							this.messageInput.value = button.dataset.question;
							this.sendMessage();
						});
					});

					this.connectWallet.addEventListener('click', () => this.connectWalletHandler());
				}

				processCryptoMessage(message) {
					let processedMessage = message;
					Object.entries(this.cryptoMap).forEach(([name, code]) => {
						const regex = new RegExp(name, 'g');
						processedMessage = processedMessage.replace(regex, code);
					});
					return processedMessage;
				}

				renderContractSecurity(data) {
					const messageDiv = document.createElement('div');
					messageDiv.className = 'message bot-message';

					try {
						const securityData = typeof data.output === 'string' ? JSON.parse(data.output) : data.output;

						const securityContainer = document.createElement('div');
						securityContainer.className = 'security-analysis';

						// 构建安全分析 UI
						securityContainer.innerHTML = `
                <div class="security-header">
                    <h3>合约安全分析报告</h3>
                    <span class="risk-badge risk-${securityData.riskLevel}">${securityData.riskLevel}</span>
                </div>
                <div class="security-details">
                    <div class="detail-item">
                        <span>合约名称</span>
                        <span>${securityData.contractName || 'Unknown'}</span>
                    </div>
                    <div class="detail-item">
                        <span>源码验证</span>
                        <span>${securityData.isVerified ? '✅ 已验证' : '❌ 未验证'}</span>
                    </div>
                    <div class="detail-item">
                        <span>风险特征</span>
                        <span>${securityData.risks.length ? securityData.risks.join(', ') : '未发现'}</span>
                    </div>
                    <div class="detail-item">
                        <span>交易分析</span>
                        <span>${securityData.txCount ? `${securityData.txCount} 笔交易` : '无交易记录'}</span>
                    </div>
                </div>
            `;

						messageDiv.appendChild(securityContainer);
					} catch (e) {
						console.error('解析安全数据失败:', e);
						messageDiv.textContent = '无法显示安全分析数据';
					}

					this.chatHistory.appendChild(messageDiv);
					this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
				}

				async sendMessage() {
					const message = this.messageInput.value.trim();
					if (!message) return;

					const processedMessage = this.processCryptoMessage(message);
					this.addMessage(message, 'user');
					this.messageInput.value = '';
					this.loading.style.display = 'block';

					try {
						const response = await fetch('http://localhost:3000/query', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ input: processedMessage }),
						});

						const data = await response.json();

						switch (data.type) {
							case 'staking_pools':
								const vaultsElement = this.renderContractSecurity(data);
								break;
							case 'crypto_trend':
								this.renderCryptoTrend(data);
								break;
							case 'crypto_price':
								this.renderCryptoPrice(data);
								break;
							default:
								this.addMessage(data.output, 'bot');
						}

						this.addToHistory(message);
					} catch (error) {
						console.error('Error:', error);
						this.addMessage('抱歉，处理您的请求时出现错误', 'bot');
					} finally {
						this.loading.style.display = 'none';
					}
				}
				renderContractSecurity(data) {
					const messageDiv = document.createElement('div');
					messageDiv.className = 'message bot-message';

					try {
						const securityData = typeof data.output === 'string' ? JSON.parse(data.output) : data.output;

						const securityContainer = document.createElement('div');
						securityContainer.className = 'security-analysis';

						securityContainer.innerHTML = `
     <table style="width:100%; border-collapse:collapse; margin-top:16px; background:white; border-radius:8px; overflow:hidden">
       <thead>
         <tr style="background:#f8f9fa; height:48px">
           <th style="padding:12px; text-align:left; font-weight:600; border-bottom:1px solid #dee2e6">Vault名称</th>
           <th style="padding:12px; text-align:center; font-weight:600; border-bottom:1px solid #dee2e6">代币</th>
           <th style="padding:12px; text-align:right; font-weight:600; border-bottom:1px solid #dee2e6">APY</th>
           <th style="padding:12px; text-align:right; font-weight:600; border-bottom:1px solid #dee2e6">总质押量</th>
           <th style="padding:12px; text-align:center; font-weight:600; border-bottom:1px solid #dee2e6">风险</th>
           <th style="padding:12px; text-align:left; font-weight:600; border-bottom:1px solid #dee2e6">合约地址</th>
         </tr>
       </thead>
       <tbody>
         ${securityData.data
				.map(
					(vault) => `
           <tr style="border-bottom:1px solid #dee2e6">
             <td style="padding:16px 12px; font-weight:500">${vault.vaultName}</td>
             <td style="padding:16px 12px; text-align:center">${vault.token}</td>
             <td style="padding:16px 12px; text-align:right; color:#28a745; font-weight:500">${vault.apy}%</td>
             <td style="padding:16px 12px; text-align:right">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(vault.totalSupply)}</td>
             <td style="padding:16px 12px; text-align:center">
               <span style="padding:4px 8px; border-radius:4px; font-size:12px; background-color:${vault.risk === '低风险' ? '#dcf5e4' : '#fff3cd'}; color:${vault.risk === '低风险' ? '#0d6832' : '#997404'}">
                 ${vault.risk}
               </span>
             </td>
             <td style="padding:16px 12px; color:#6c757d; font-family:monospace">${vault.contractAddress.slice(0, 6)}...${vault.contractAddress.slice(-4)}</td>
           </tr>
         `,
				)
				.join('')}
       </tbody>
     </table>
   `;

						messageDiv.appendChild(securityContainer);
					} catch (e) {
						console.error('解析数据失败:', e);
						messageDiv.textContent = '无法显示数据';
					}

					this.chatHistory.appendChild(messageDiv);
					this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
				}
				renderCryptoTrend(data) {
					const messageDiv = document.createElement('div');
					messageDiv.className = 'message bot-message';

					const chartContainer = document.createElement('div');
					messageDiv.appendChild(chartContainer);

					const root = ReactDOM.createRoot(chartContainer);
					root.render(
						React.createElement(CryptoPriceChart, {
							data: data.output.priceData,
							symbol: data.output.symbol,
						}),
					);

					this.chatHistory.appendChild(messageDiv);
					this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
				}

				renderCryptoPrice(data) {
					const messageDiv = document.createElement('div');
					messageDiv.className = 'message bot-message';

					try {
						const parsedData = typeof data.output === 'string' ? JSON.parse(data.output) : data.output;

						// 创建价格显示容器
						const priceContainer = document.createElement('div');
						priceContainer.className = 'crypto-price';
						priceContainer.innerHTML = `
            <h3>${parsedData.symbol} 实时行情</h3>
            <div class="price-main">${parsedData.formattedPrice}</div>
            <div class="price-info">最后更新: ${new Date(parsedData.lastUpdated).toLocaleString()}</div>
        `;
						messageDiv.appendChild(priceContainer);

						// 如果有历史数据，创建图表
						if (parsedData.history && parsedData.history.length > 0) {
							const chartContainer = document.createElement('div');
							chartContainer.style.height = '400px';
							chartContainer.style.marginTop = '20px';
							messageDiv.appendChild(chartContainer);

							// 处理数据
							const chartData = parsedData.history.map((item) => [
								new Date(item.date).getTime(),
								item.close,
							]);

							// 创建图表
							Highcharts.chart(chartContainer, {
								chart: {
									type: 'line',
									style: {
										fontFamily: 'Arial, sans-serif',
									},
								},
								title: {
									text: `${parsedData.symbol} 7天价格走势`,
									style: {
										fontSize: '16px',
									},
								},
								xAxis: {
									type: 'datetime',
									labels: {
										format: '{value:%m/%d}',
									},
								},
								yAxis: {
									title: {
										text: '价格 (USD)',
									},
									labels: {
										formatter: function () {
											return '$' + Highcharts.numberFormat(this.value, 0, '.', ',');
										},
									},
								},
								legend: {
									enabled: false,
								},
								tooltip: {
									formatter: function () {
										return (
											'<b>' +
											Highcharts.dateFormat('%Y-%m-%d', this.x) +
											'</b><br/>' +
											'价格: $' +
											Highcharts.numberFormat(this.y, 2, '.', ',')
										);
									},
								},
								series: [
									{
										name: '价格',
										data: chartData,
										color: '#007bff',
										marker: {
											enabled: false,
										},
									},
								],
								plotOptions: {
									series: {
										lineWidth: 2,
									},
								},
							});

							// 添加统计信息
							const prices = parsedData.history.map((item) => item.close);
							const firstPrice = prices[0];
							const lastPrice = prices[prices.length - 1];
							const priceChange = (((lastPrice - firstPrice) / firstPrice) * 100).toFixed(2);
							const maxPrice = Math.max(...prices);
							const minPrice = Math.min(...prices);

							const statsContainer = document.createElement('div');
							statsContainer.style.display = 'flex';
							statsContainer.style.justifyContent = 'space-between';
							statsContainer.style.marginTop = '20px';
							statsContainer.style.padding = '15px';
							statsContainer.style.backgroundColor = '#f8f9fa';
							statsContainer.style.borderRadius = '8px';
							statsContainer.style.textAlign = 'center'; // 添加居中对齐

							const commonLabelStyle = 'color: #666; font-size: 14px; margin-bottom: 8px;'; // 添加底部间距
							const commonValueStyle = 'font-size: 16px; font-weight: bold; white-space: nowrap;'; // 保持数值为一行

							statsContainer.innerHTML = `
						<div style="flex: 1; padding: 0 10px;">
							<div style="${commonLabelStyle}">7天涨跌</div>
							<div style="${commonValueStyle}; color: ${priceChange >= 0 ? '#28a745' : '#dc3545'};">
								${priceChange}%
							</div>
						</div>
						<div style="flex: 1; padding: 0 10px; border-left: 1px solid #dee2e6; border-right: 1px solid #dee2e6;">
							<div style="${commonLabelStyle}">最高价</div>
							<div style="${commonValueStyle}; color: #28a745;">
								$${Highcharts.numberFormat(maxPrice, 0, '.', ',')}
							</div>
						</div>
						<div style="flex: 1; padding: 0 10px;">
							<div style="${commonLabelStyle}">最低价</div>
							<div style="${commonValueStyle}; color: #dc3545;">
								$${Highcharts.numberFormat(minPrice, 0, '.', ',')}
							</div>
						</div>
					`;

							messageDiv.appendChild(statsContainer);
						}
					} catch (e) {
						console.error('解析价格数据失败:', e);
						messageDiv.textContent = '无法显示价格数据';
					}

					this.chatHistory.appendChild(messageDiv);
					this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
				}

				addMessage(content, type) {
					const messageDiv = document.createElement('div');
					messageDiv.className = `message ${type}-message`;
					messageDiv.textContent = content;
					this.chatHistory.appendChild(messageDiv);
					this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
				}

				addToHistory(message) {
					const historyItem = document.createElement('div');
					historyItem.className = 'history-item';
					historyItem.textContent = message;
					historyItem.addEventListener('click', () => {
						this.messageInput.value = message;
						this.sendMessage();
					});
					this.historyList.insertBefore(historyItem, this.historyList.firstChild);
				}

				async connectWalletHandler() {
					if (typeof window.ethereum !== 'undefined') {
						try {
							const accounts = await window.ethereum.request({
								method: 'eth_requestAccounts',
							});
							const address = accounts[0];
							this.walletInfo.innerHTML = `
                    <p>已连接钱包</p>
                    <p>${address.slice(0, 6)}...${address.slice(-4)}</p>
                `;
							this.connectWallet.style.display = 'none';
						} catch (error) {
							console.error('连接钱包失败:', error);
						}
					} else {
						alert('请安装 MetaMask!');
					}
				}

				async checkWalletConnection() {
					if (typeof window.ethereum !== 'undefined') {
						const accounts = await window.ethereum.request({ method: 'eth_accounts' });
						if (accounts.length > 0) {
							this.walletInfo.innerHTML = `
                    <p>已连接钱包</p>
                    <p>${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}</p>
                `;
							this.connectWallet.style.display = 'none';
						}
					}
				}

				formatNumber(number) {
					return new Intl.NumberFormat('en-US', {
						maximumFractionDigits: 0,
					}).format(number);
				}
			}

			// 初始化应用
			document.addEventListener('DOMContentLoaded', () => {
				new ChatApp();
			});
		</script>
	</body>
</html>
