<!doctype html>
<html lang="zh">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AI Agent 助手</title>
		<style>
			/* 基础样式 */
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: Arial, sans-serif;
				height: 100vh;
				display: flex;
			}

			/* 左侧历史记录 */
			.history-panel {
				width: 250px;
				background: #f7f7f7;
				padding: 20px;
				border-right: 1px solid #ddd;
				overflow-y: auto;
			}

			.history-item {
				padding: 10px;
				margin-bottom: 8px;
				background: white;
				border-radius: 8px;
				cursor: pointer;
				border: 1px solid #eee;
			}

			.history-item:hover {
				background: #f0f0f0;
			}

			/* 中间聊天区域 */
			.chat-panel {
				flex: 1;
				display: flex;
				flex-direction: column;
				background: white;
			}

			.chat-history {
				flex: 1;
				padding: 20px;
				overflow-y: auto;
			}

			.message {
				margin-bottom: 20px;
				max-width: 80%;
				white-space: pre-wrap;
				word-wrap: break-word;
			}

			.user-message {
				margin-left: auto;
				background: #007bff;
				color: white;
				padding: 12px 16px;
				border-radius: 12px 12px 0 12px;
			}

			.bot-message {
				background: #f8f9fa;
				padding: 12px 16px;
				border-radius: 12px 12px 12px 0;
				border: 1px solid #eee;
			}

			/* 质押池表格样式 */
			.pools-table {
				width: 100%;
				border-collapse: collapse;
				margin: 10px 0;
				background: white;
				border-radius: 8px;
				overflow: hidden;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			.pools-table th,
			.pools-table td {
				padding: 12px;
				text-align: left;
				border-bottom: 1px solid #eee;
			}

			.pools-table th {
				background: #f8f9fa;
				font-weight: 600;
			}

			.pools-table .apy {
				color: #28a745;
				font-weight: bold;
			}

			.stake-button {
				display: inline-block;
				padding: 6px 12px;
				background: #007bff;
				color: white;
				text-decoration: none;
				border-radius: 4px;
				font-size: 0.9em;
			}

			.stake-button:hover {
				background: #0056b3;
			}

			/* 快捷问题区域 */
			.quick-questions {
				padding: 15px;
				border-bottom: 1px solid #ddd;
				display: flex;
				gap: 10px;
				overflow-x: auto;
			}

			.quick-question {
				padding: 8px 16px;
				background: white;
				border: 1px solid #ddd;
				border-radius: 20px;
				cursor: pointer;
				white-space: nowrap;
			}

			.quick-question:hover {
				background: #f0f0f0;
			}

			/* 输入区域 */
			.input-area {
				padding: 20px;
				border-top: 1px solid #ddd;
				background: #f8f9fa;
			}

			#messageInput {
				width: 100%;
				padding: 12px;
				border: 1px solid #ddd;
				border-radius: 8px;
				margin-bottom: 10px;
				resize: vertical;
				min-height: 60px;
			}

			#sendButton {
				padding: 10px 20px;
				background: #007bff;
				color: white;
				border: none;
				border-radius: 8px;
				cursor: pointer;
			}

			#sendButton:hover {
				background: #0056b3;
			}

			/* 右侧钱包区域 */
			.wallet-panel {
				width: 300px;
				background: #f7f7f7;
				padding: 20px;
				border-left: 1px solid #ddd;
			}

			.wallet-connect {
				padding: 10px;
				background: #28a745;
				color: white;
				border: none;
				border-radius: 4px;
				width: 100%;
				cursor: pointer;
				margin-bottom: 15px;
			}

			.wallet-connect:hover {
				background: #218838;
			}

			.loading {
				display: none;
				text-align: center;
				padding: 20px;
			}

			.loading.active {
				display: block;
			}
		</style>
	</head>
	<body>
		<div class="history-panel">
			<h3>历史记录</h3>
			<div id="historyList"></div>
		</div>

		<div class="chat-panel">
			<div class="quick-questions">
				<button class="quick-question" data-question="比特币的当前价格是多少？">比特币价格</button>
				<button class="quick-question" data-question="推荐一些稳定币质押方案">推荐质押方案</button>
				<button class="quick-question" data-question="你是谁？">关于AI助手</button>
			</div>

			<div class="chat-history" id="chatHistory"></div>

			<div id="loading" class="loading">AI思考中...</div>

			<div class="input-area">
				<textarea id="messageInput" placeholder="请输入你的问题..." rows="3"></textarea>
				<button id="sendButton">发送</button>
			</div>
		</div>

		<div class="wallet-panel">
			<button id="connectWallet" class="wallet-connect">连接钱包</button>
			<div id="walletInfo"></div>
		</div>

		<script>
			class ChatApp {
				constructor() {
					this.messageInput = document.getElementById('messageInput');
					this.sendButton = document.getElementById('sendButton');
					this.chatHistory = document.getElementById('chatHistory');
					this.loading = document.getElementById('loading');
					this.historyList = document.getElementById('historyList');
					this.connectWallet = document.getElementById('connectWallet');
					this.walletInfo = document.getElementById('walletInfo');

					// 加密货币映射表
					this.cryptoMap = {
						比特币: 'BTC',
						以太坊: 'ETH',
						泰达币: 'USDT',
						币安币: 'BNB',
						索拉纳: 'SOL',
					};

					this.initializeEventListeners();
					this.checkWalletConnection();
				}

				initializeEventListeners() {
					this.sendButton.addEventListener('click', () => this.sendMessage());
					this.messageInput.addEventListener('keypress', (e) => {
						if (e.key === 'Enter' && !e.shiftKey) {
							e.preventDefault();
							this.sendMessage();
						}
					});

					document.querySelectorAll('.quick-question').forEach((button) => {
						button.addEventListener('click', () => {
							this.messageInput.value = button.dataset.question;
							this.sendMessage();
						});
					});

					this.connectWallet.addEventListener('click', () => this.connectWalletHandler());
				}

				// 处理加密货币名称转换
				processCryptoMessage(message) {
					let processedMessage = message;
					Object.entries(this.cryptoMap).forEach(([name, code]) => {
						const regex = new RegExp(name, 'g');
						processedMessage = processedMessage.replace(regex, code);
					});
					return processedMessage;
				}

				async sendMessage() {
					const message = this.messageInput.value.trim();
					if (!message) return;

					// 处理消息中的加密货币名称
					const processedMessage = this.processCryptoMessage(message);

					this.addMessage(message, 'user');
					this.messageInput.value = '';
					this.loading.style.display = 'block';

					try {
						const response = await fetch('http://localhost:3000/query', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ input: processedMessage }),
						});

						const data = await response.json();

						if (data.type === 'staking_pools') {
							this.renderStakingPools(data);
						} else if (data.type === 'crypto_price') {
							this.renderCryptoPrice(data);
						} else {
							this.addMessage(data.output, 'bot');
						}

						this.addToHistory(message);
					} catch (error) {
						console.error('Error:', error);
						this.addMessage('抱歉，处理您的请求时出现错误', 'bot');
					} finally {
						this.loading.style.display = 'none';
					}
				}

				renderStakingPools(data) {
					const messageDiv = document.createElement('div');
					messageDiv.className = 'message bot-message';
					messageDiv.innerHTML = this.formatStakingPoolsHtml(data.output);
					this.chatHistory.appendChild(messageDiv);
					this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
				}

				renderCryptoPrice(data) {
					const messageDiv = document.createElement('div');
					messageDiv.className = 'message bot-message';
					messageDiv.innerHTML = this.formatCryptoPriceHtml(data.output);
					this.chatHistory.appendChild(messageDiv);
					this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
				}

				formatStakingPoolsHtml(output) {
					// 将文本格式的输出转换为HTML表格
					const lines = output.split('\n');
					let html = '<div class="pools-container">';
					html += '<table class="pools-table">';
					html += '<thead><tr><th>池子</th><th>APY</th><th>总供应量</th><th>风险</th></tr></thead>';
					html += '<tbody>';

					let currentPool = null;
					lines.forEach((line) => {
						if (line.endsWith(':') && !line.startsWith('-')) {
							currentPool = {
								name: line.slice(0, -1),
							};
						} else if (line.startsWith('- 当前 APY:')) {
							currentPool.apy = line.match(/[\d.]+/)[0];
						} else if (line.startsWith('- TVL')) {
							currentPool.tvl = line.match(/\$[\d,]+/)[0];
						} else if (line.startsWith('- 风险')) {
							currentPool.risk = line.split(': ')[1];
							// 添加完整的池子信息
							html += `
                   <tr>
                       <td>${currentPool.name}</td>
                       <td class="apy">${currentPool.apy}%</td>
                       <td>${currentPool.tvl}</td>
                       <td>${currentPool.risk}</td>
                   </tr>
               `;
						}
					});

					html += '</tbody></table>';
					html += '</div>';
					return html;
				}

				formatCryptoPriceHtml(output) {
					const lines = output.split('\n');
					console.log('lines: ', lines);
					let html = '<div class="crypto-price">';

					lines.forEach((line) => {
						if (line.includes('实时行情')) {
							html += `<h3>${line}</h3>`;
						} else if (line.includes('当前价格')) {
							html += `<div class="price-main">${line}</div>`;
						} else if (line.includes('24h变化')) {
							const isPositive = line.includes('↑');
							html += `<div class="price-change ${isPositive ? 'positive' : 'negative'}">${line}</div>`;
						} else if (line) {
							html += `<div class="price-info">${line}</div>`;
						}
					});

					html += '</div>';
					return html;
				}

				addMessage(content, type) {
					const messageDiv = document.createElement('div');
					messageDiv.className = `message ${type}-message`;
					messageDiv.textContent = content;
					this.chatHistory.appendChild(messageDiv);
					this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
				}

				addToHistory(message) {
					const historyItem = document.createElement('div');
					historyItem.className = 'history-item';
					historyItem.textContent = message;
					historyItem.addEventListener('click', () => {
						this.messageInput.value = message;
						this.sendMessage();
					});
					this.historyList.insertBefore(historyItem, this.historyList.firstChild);
				}

				async connectWalletHandler() {
					if (typeof window.ethereum !== 'undefined') {
						try {
							const accounts = await window.ethereum.request({
								method: 'eth_requestAccounts',
							});
							const address = accounts[0];
							this.walletInfo.innerHTML = `
                   <p>已连接钱包</p>
                   <p>${address.slice(0, 6)}...${address.slice(-4)}</p>
               `;
							this.connectWallet.style.display = 'none';
						} catch (error) {
							console.error('连接钱包失败:', error);
						}
					} else {
						alert('请安装 MetaMask!');
					}
				}

				async checkWalletConnection() {
					if (typeof window.ethereum !== 'undefined') {
						const accounts = await window.ethereum.request({ method: 'eth_accounts' });
						if (accounts.length > 0) {
							this.walletInfo.innerHTML = `
                   <p>已连接钱包</p>
                   <p>${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}</p>
               `;
							this.connectWallet.style.display = 'none';
						}
					}
				}
			}

			document.addEventListener('DOMContentLoaded', () => {
				new ChatApp();
			});
		</script>
	</body>
</html>
